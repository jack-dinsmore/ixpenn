# Description

A repository to contain the Romani group's IXPE data processed with Neural Nets (NN).

A. Lawrence Peirson is the original author of the NN software

Jack Dinsmore created the level1 to level2 pipeline and maintains this directory on Sherlock.

# Installation

Thanks to Peter Lindholm and Kaitlyn Karpovich for helping to bug test the installation process. This software is compatible with HEASoft version 6.32.1. Below are the installation instructions for the pipeline

1. (Sherlock users skip this step) Many python modules are listed in src/mlnn.sh, src/mlixpe.sh, and src/mlbg.sh. If you have a computing cluster, replace the lines in these files with the appropriate loading statements for your cluster. If not, pip install each module and delete the text in these files.

2. Pip install `scikit-learn` with version 0.24.2, `multiprocess` with version 0.70.12.2, and `setuptools` with version 39.2.0. These are necessary for neural net processing. Make sure to do this in the same python environment as the one that contains the python modules you installed in step one. If you skipped step one, run src/mlnn.sh to load the environment.

3. Install `apex` via git by running the following in your home directory
```bash
git clone https://github.com/NVIDIA/apex.git
git checkout 5ba7af18f0cdb228b00ee7110236dc7c1b23fc35
pip install -v --disable-pip-version-check --no-build-isolation --no-cache-dir ./
```
Note that `pip install apex` does not work; the PyPI version of `apex` is an unrelated module.

4. Change the flags at the start of `source_select.sh`. These flags specify the locations of various compilers and your HEASarc installation.


# Instructions

0. *Preparation*.
* Download the IXPE observation to the `data/` directory. The `hk`, `auxil`, and `event_l1` directories are all necessary; `event_l2` is optional.
* Unzip all files, e.g. with `gunzip`.
* If each fits file in `event_l1` is more than 2 million counts (check this with the HEAsoft `ftlist` tool), consider splitting them into 1-2 million count chunks to reduce memory overhead. You should use "chunk" names that are distinct from the observation number or the set number, and this should be reflected in `source_select.sh`.
* Update `source_select.sh` with the metadata for this source. That file contains instructions on what metadata is necessary.

1. *Reconstruct the event data*. Run `1init.sh` using the following command, where `YOUR_SOURCE_NAME` is replaced with the name you chose to use in `source_select.sh`. This might take an hour or so.
```
sbatch --export=SOURCE=YOUR_SOURCE_NAME 1init.sh
```
If you are only interested in doing moments processing, pass the `USE_MOM` flag using `--export=SOURCE=YOUR_SOURCE_NAME,USE_MOM=a` and skip to step 4.

2. *Convert the hexagonal grid to square*. Run `2hex.sh` using the same command, with `1init.sh` replaced with `2hex.sh`. This may take a little under an hour.

3. *Run the NN processing*. Run `3nn.sh` in the same way. This may take a full day to run. On Sherlock, the process is even slower because of ~days of waiting time.

4. *Delete unused data to save space*. Run `4delete.sh` using the same format. This deletes the data generated by steps 2 and 3, and also removes all reference to the original tracks. If you want to keep the NN and hex data, only run the `python3 recon_trim.py` and `python3 hack-fits.py` lines. You should eventually run the entire `delete` script because the files are very large. This will take a few minutes.

5. *Run the systematic correction codes published by the IXPE collaboration*. Run `5correct.sh`. If you'd like to only repeat the Mom reconstruction, add the `USE_MOM` flag as in step 1. This will correct for gain and spurious modulation, and distill the event information down to the standard level 2 columns. It will take about an hour. WARNING: this does not correct the GTIs and exposure times listed in the header. Best practice is to copy the GTIs over from the HEASarc level 2 files.

6. *Run boom drift correction (optional)*. By default, the pipeline uses `ixpeaspcorr` to remove boom drift. For some observations (e.g. faint or extended ones), `ixpeboomdriftcorr` is better. `6unasp.sh` runs `ixpeboomdriftcorr`. It also makes the uncorrected files available. This will take a few minutes.

7. *Generate particle characters (optional)*. Run `7bkg.sh` to use the LeakageLib particle character neural net to assign particle weights. You can also do this yourself with the program available in leakagelib. This will take about half an hour. By default, this will run on the `ixpeaspcorr` files. If you wish to assign particle characters to the `boomdriftcorr` files, run with the flag `USE_BOOM=a` using the same syntax as `USE_MOM`, mentioned above.

8. *Check the logs for errors*. Run `error_check.sh LOG_FILES` at any point, replacing `LOG_FILES` with the log files you'd like to check for errors. This can be done manually of course, but since the logs are long it can be easy to miss the messages.

The processed files are available in the `event_nn` folder in the location where you downloaded the data. If you used the `USE_MOM=a` flag, then they are available in `event_mom`. Those processed with `ixpeaspcorr` (default) end with `_l2`. Those processed with `ixpeboomdriftcorr` end with `_l2_boom`, and those without boom drift correction end with `_l2_uncorr`. If background characters were added, then `_bkg` is appended to the file name.

# Issues

* This script does not touch the GTIs or exposure time keywords, so the output GTIs will be wrong. The HEASarc pipeline corrects GTIs. If you need this information, you should copy the GTI information from HEASarc's level 2 file to the files output by this pipeline. If you know how HEASarc corrects GTIs, please let me know and I'll add it to this pipeline.

* This pipeline and the HEASarc pipeline produce event lists with slightly different numbers of events. The difference likely has to do with the STATUS flag cuts used. This difference is usually ~1%, and should not affect analyses. 

* For the events common to both this pipeline and the HEASarc pipeline, if you are seeing differences in the reconstructed energy, position, or polarization when `USE_MOM` is set, you may be using an out-of-date CALDB or HEASoft version.

